<template>
  <Table
    title="Controle de comissões"
    font-size="1.5rem"
    :items="$all"
    :headers="headers"
    @add="showForm = true"
    :loading="loading"
    :show-crud="false"
    show-select
    v-model="comissionsSelecteds"
  >
    <template #top-table>
      <v-row dense class="mt-4">
        <v-col cols="12" lg="2">
          <DatePicker
            v-model="filters.initialDate"
            label="Data Inicial"
            variant="outlined"
            color="primary"
            hide-details
          />
        </v-col>
        <v-col cols="12" lg="2">
          <DatePicker
            v-model="filters.finalDate"
            label="Data Final"
            variant="outlined"
            color="primary"
            hide-details
          />
        </v-col>
        <v-col cols="12" lg="2">
          <SelectInput
            label="Status"
            v-model="filters.status"
            :items="[
              //{ title: 'Todos', value: 'all' },
              { title: 'Pendente', value: 'pending' },
              { title: 'Paga', value: 'paid' },
              { title: 'Canceladas', value: 'cancel' },
            ]"
            item-title="title"
            item-value="value"
            @update:model-value="handleGetComissions"
          />
        </v-col>
        <v-col cols="12" lg="2">
          <SelectInput
            label="Tipo de comissão"
            v-model="filters.comissionType"
            :items="[
              { title: 'Vendedor', value: 'seller' },
              { title: 'Médico', value: 'medic' },
              { title: 'Atendente', value: 'atendent' },
            ]"
            item-title="title"
            item-value="value"
            @update:model-value="handleModelValueComissionType"
          />
        </v-col>
        <v-col cols="12" lg="4">
          <SelectSearchSeller
            v-if="filters.comissionType === 'seller'"
            v-model="filters.user"
          />
          <SelectSearchMedic
            v-else-if="filters.comissionType === 'medic'"
            v-model="filters.user"
          />
        </v-col>
      </v-row>
      <v-row dense class="py-4">
        <v-col
          cols="12"
          lg="2"
          class="d-flex align-center text-primary"
          style="gap: 0.5rem"
        >
          <span>Total:</span>
          <strong style="font-size: 1rem">{{ $total }}</strong>
        </v-col>
        <v-col
          cols="12"
          lg="2"
          class="d-flex align-center text-primary"
          style="gap: 0.5rem"
        >
          <span>Total Selecionado:</span>
          <strong style="font-size: 1rem">{{ $totalSelected }}</strong>
        </v-col>
        <v-col
          cols="12"
          lg="8"
          class="d-flex flex-wrap align-center justify-end mb-4"
          style="gap: 0.5rem"
        >
          <Button
            variant="outlined"
            color="grey"
            class="text-none"
            size="small"
            @click="router.back()"
          >
            <v-icon icon="mdi-arrow-left" color="darkText" />
            <span class="text-darkText text-caption"> Voltar </span>
          </Button>
          <Button
            color="primary"
            variant="flat"
            size="small"
            class="text-none"
            @click="handleGetComissions"
          >
            <v-icon icon="mdi-filter-outline" start color="colorIcon" />
            <span class="text-caption"> Filtrar </span>
          </Button>

          <Button
            color="green"
            variant="flat"
            size="small"
            class="text-none"
            :disabled="
              !filters.user ||
              comissionsSelecteds.length === 0 ||
              filters.status !== 'pending'
            "
            @click="handleShowQRCodePix"
          >
            <v-icon icon="mdi-check-all" start />
            <span class="text-caption"> Pagar selecionadas </span>
          </Button>
          <Button
            color="red"
            variant="flat"
            size="small"
            class="text-none"
            :disabled="!filters.user || comissionsSelecteds.length === 0"
            @click="showCancelComissionDialog = true"
          >
            <v-icon icon="mdi-cancel" start />
            <span class="text-caption"> Cancelar selecionadas </span>
          </Button>
        </v-col>
      </v-row>
    </template>
    <template v-slot:item.user="{ item }">
      <v-expansion-panels flat>
        <v-expansion-panel>
          <v-expansion-panel-title>
            <v-row dense>
              <v-col cols="12" lg="4">
                <span class="font-weight-bold text-primary">{{
                  item.user.name
                }}</span>
              </v-col>
              <v-col cols="12" lg="2">
                <span
                  class="text-caption text-medium-emphasis"
                  style="width: 7rem"
                >
                  Data: {{ formatDate(item.comissionDate) }}
                </span>
              </v-col>
              <v-col cols="12" lg="2">
                Valor:
                <strong class="ml-1">
                  {{ amountFormated(Number(item.comissionValue ?? "0"), true) }}
                </strong>
              </v-col>
              <v-col cols="12" lg="2">
                Tipo:
                <strong class="ml-1">
                  {{ getComissionType(item.comissionType) }}
                </strong>
              </v-col>
              <v-col cols="12" lg="2">
                <v-chip
                  density="compact"
                  :color="item.comissionStatus === 'paid' ? 'green' : 'orange'"
                  :prepend-icon="
                    item.comissionStatus === 'paid'
                      ? 'mdi-check-all'
                      : 'mdi-clock-outline'
                  "
                  class="text-none"
                >
                  <strong>
                    {{ getComisstionStatus(item.comissionStatus) }}
                  </strong>
                </v-chip>
              </v-col>
            </v-row>
          </v-expansion-panel-title>
          <v-expansion-panel-text>
            <v-row dense>
              <v-col cols="12" lg="3">
                <div class="font-weight-bold">Data pagamento:</div>
                <div class="text-caption text-medium-emphasis">
                  {{ formatDate(item.comissionDatePaid) }}
                </div>
              </v-col>
              <v-col cols="12" lg="3">
                <div class="font-weight-bold">Tipo comissão:</div>
                <div class="text-caption text-medium-emphasis">
                  <span>
                    {{
                      Number(item.comissionPercentage ?? 0) > 0
                        ? `${amountFormated(
                            Number(item.comissionPercentage ?? "0"),
                            false
                          )}%`
                        : "Comissão fixa"
                    }}
                  </span>
                </div>
              </v-col>
              <v-col cols="12" lg="3">
                <div class="font-weight-bold">Base Comissão:</div>
                <div class="text-caption text-medium-emphasis">
                  <span>
                    {{
                      amountFormated(Number(item.comissionBase ?? "0"), true)
                    }}
                  </span>
                </div>
              </v-col>
              <v-col cols="12" lg="3" class="d-flex justify-end">
                <Button
                  color="blue"
                  variant="text"
                  size="small"
                  @click="getComissionDetails(item)"
                >
                  <v-icon
                    icon="mdi-dots-vertical-circle-outline"
                    size="20"
                    start
                  />

                  Detalhar comissão
                </Button>
              </v-col>
              <v-col cols="12">
                <div class="text-caption text-medium-emphasis">
                  {{ item.comissionObservation }}
                </div>
              </v-col>
            </v-row>
          </v-expansion-panel-text>
        </v-expansion-panel>
      </v-expansion-panels>
    </template>

    <!-- <template v-slot:item.user="{ item }">
      <span>{{ item.user.name }}</span>
    </template>
    <template v-slot:item.comissionDate="{ item }">
      <span>{{ formatDate(item.comissionDate) }}</span>
    </template>
    <template v-slot:item.comissionDatePaid="{ item }">
      <span>{{ formatDate(item.comissionDatePaid) }}</span>
    </template>
    <template v-slot:item.comissionPercentage="{ item }">
      <span>
        {{
          Number(item.comissionPercentage ?? 0) > 0
            ? `${amountFormated(
                Number(item.comissionPercentage ?? "0"),
                false
              )}%`
            : "Comissão fixa"
        }}
      </span>
    </template>
    <template v-slot:item.comissionValue="{ item }">
      <strong>
        {{ amountFormated(Number(item.comissionValue ?? "0"), true) }}
      </strong>
    </template>
    <template v-slot:item.comissionBase="{ item }">
      <span>
        {{ amountFormated(Number(item.comissionBase ?? "0"), true) }}
      </span>
    </template>
    <template v-slot:item.comissionType="{ item }">
      <span>
        {{ getComissionType(item.comissionType) }}
      </span>
    </template>
    <template v-slot:item.comissionStatus="{ item }">
      <v-chip
        density="compact"
        :color="item.comissionStatus === 'paid' ? 'green' : 'orange'"
        :prepend-icon="
          item.comissionStatus === 'paid'
            ? 'mdi-check-all'
            : 'mdi-clock-outline'
        "
        class="text-none"
      >
        <strong>
          {{ getComisstionStatus(item.comissionStatus) }}
        </strong>
      </v-chip>
    </template>
    <template v-slot:item.actions="{ item }">
      <v-btn
        icon
        color="blue"
        variant="text"
        size="small"
        @click="getComissionDetails(item)"
      >
        <v-icon icon="mdi-dots-vertical-circle-outline" size="20"></v-icon>
        <v-tooltip
          activator="parent"
          location="top center"
          content-class="tooltip-background"
        >
          Detalhar comissão
        </v-tooltip>
      </v-btn>
    </template> -->
  </Table>
  <Dialog
    title="Cancelar comissão"
    :dialog="showCancelComissionDialog"
    @cancel="showCancelComissionDialog = false"
    :show-cancel="true"
    @confirm="handleCancelComissions"
  >
    <strong>Confirma o cancelamento de todas as comssões selecionadas ?</strong>
  </Dialog>
  <DialogLoading :dialog="loading" />
  <ComissionDetails v-model="showComissionDetails" />
  <QRCodePix
    v-model="showQRCodePix"
    :parameters="qrcodePixParameters"
    @confirm="handlePaidComissions"
  />
</template>

<script setup lang="ts">
import dayjs from "dayjs";

const comission = useComissionStore();
const router = useRouter();
const { formatDate, amountFormated } = useUtils();

const $all = computed(() => comission.$all);
const $total = computed(() => {
  const total = comission.$all.reduce((acc, item) => {
    return acc + (Number(item.comissionValue) || 0);
  }, 0);
  return amountFormated(total, false);
});
const $totalSelected = computed(() => {
  const total = comissionsSelecteds.value.reduce((acc, item) => {
    return acc + (Number(item.comissionValue) || 0);
  }, 0);
  return amountFormated(total, false);
});
const showForm = ref(false);
const loading = ref(false);
const showQRCodePix = ref(false);
const qrcodePixParameters = ref<IQRCodeParameter>({
  version: "01",
  key: "",
  city: "",
  name: "",
  value: 0,
  transactionId: "",
  message: "",
  cep: "",
  currency: 986,
  countryCode: "BR",
});
//const showPaidComissionDialog = ref(false);
const showCancelComissionDialog = ref(false);
const showComissionDetails = ref(false);
const comissionsSelecteds = ref([] as ComissionProps[]);

const filters = ref({
  comissionType: "seller",
  initialDate: dayjs().startOf("month").format("YYYY-MM-DD"),
  finalDate: dayjs().endOf("month").format("YYYY-MM-DD"),
  status: "pending",
  user: undefined as UserProps | undefined,
});

const headers = ref([
  { title: "Beneficiado", key: "user" },
  // { title: "Data comissão", key: "comissionDate" },
  // { title: "%Comissão", key: "comissionPercentage" },
  // { title: "Base comissão", key: "comissionBase" },
  // { title: "Valor comissão", key: "comissionValue" },
  // { title: "Status", key: "comissionStatus" },
  // { title: "Data pagamento", key: "comissionDatePaid" },
  // { title: "Tipo", key: "comissionType" },
  // { title: "Ações", key: "actions" },
]);

onUnmounted(() => {
  comission.clear();
});

const getComissionType = (type: string) => {
  switch (type) {
    case "seller":
      return "Vendedor";
    case "medic":
      return "Médico";
    default:
      return "Desconhecido";
  }
};

const getComisstionStatus = (status: string) => {
  switch (status) {
    case "paid":
      return "Pago";
    case "pending":
      return "Pendente";
    case "cancel":
      return "Cancelado";
    default:
      return "Desconhecido";
  }
};

const handleModelValueComissionType = async () => {
  filters.value.user = undefined;
  await handleGetComissions();
};

const handleGetComissions = async () => {
  loading.value = true;
  try {
    await comission.index({
      initialDate: filters.value.initialDate,
      finalDate: filters.value.finalDate,
      status: filters.value.status !== "all" ? filters.value.status : undefined,
      comissionType: filters.value.comissionType,
      userId: filters.value.user?.id,
    });
    comissionsSelecteds.value = [];
  } catch (error) {
    console.error("Error fetching comissions:", error);
  } finally {
    loading.value = false;
  }
};

const handlePaidComissions = async () => {
  if (comissionsSelecteds.value.length === 0) return;

  loading.value = true;
  try {
    for (const comissionItem of comissionsSelecteds.value) {
      if (!comissionItem.publicId) continue;
      await comission.paidComission(comissionItem.publicId);
    }

    comissionsSelecteds.value = [];
    await handleGetComissions();
  } catch (error) {
    console.error("Error paying comissions:", error);
  } finally {
    //showPaidComissionDialog.value = false;
    loading.value = false;
  }
};

const handleCancelComissions = async () => {
  if (comissionsSelecteds.value.length === 0) return;

  loading.value = true;
  try {
    for (const comissionItem of comissionsSelecteds.value) {
      await comission.cancelComission(comissionItem.publicId!);
    }
    comissionsSelecteds.value = [];

    await handleGetComissions();
  } catch (error) {
    console.error("Error paying comissions:", error);
  } finally {
    showCancelComissionDialog.value = false;
    loading.value = false;
  }
};

const getComissionDetails = async (item: ComissionProps) => {
  if (!item.publicId) return;

  loading.value = true;
  try {
    await comission.show(item.publicId);
    showComissionDetails.value = true;
  } finally {
    loading.value = false;
  }
};
const handleShowQRCodePix = () => {
  qrcodePixParameters.value = {
    version: "01",
    key: filters.value.user?.pixKey || "",
    city: filters.value.user?.UserAddress?.addressCity || "",
    name: filters.value.user?.name || "",
    value:
      Number($totalSelected.value.replace(",", ".").replace("R$", "").trim()) ||
      0,
    message: `Pagamento de comissão referente a ${formatDate(
      comissionsSelecteds.value?.[0]?.comissionDate
    )}`,
  };

  showQRCodePix.value = true;
};
</script>
